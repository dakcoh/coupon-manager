# Coupon Manager

---
## 0. 동시성 처리
Coupon의 동시성 처리를 공부해보는 프로젝트입니다.

## 1. 서비스 개요
Coupon Manager는 **쿠폰을 생성하고, 발급하고, 사용할 수 있도록 관리**하는 시스템입니다.
사용자는 특정 이벤트나 프로모션을 통해 쿠폰을 받고, 이를 사용해 할인 혜택을 받을 수 있습니다.

### 서비스 흐름
1. 관리자가 새로운 쿠폰을 생성합니다.
2. 사용자가 특정 쿠폰을 발급받습니다.
3. 발급된 쿠폰을 사용하여 혜택을 받습니다.

## 2. 요구사항
- 관리자는 쿠폰을 생성할 수 있어야 합니다.
- 사용자는 특정 쿠폰을 발급받을 수 있어야 합니다.
- 동일한 사용자가 중복 발급할 수 없도록 방지해야 합니다.
- 여러 사용자가 동시에 요청할 때, 중복 발급 및 중복 사용이 발생하지 않도록 제어해야 합니다.

## 3. 구현 방식
### **왜 퍼사드 패턴을 사용했을까?**
퍼사드 패턴을 사용하면 **여러 서비스 로직을 하나의 진입점**에서 관리할 수 있습니다.
이 덕분에 컨트롤러는 내부 비즈니스 로직을 직접 호출할 필요 없이 **퍼사드(Facade)를 통해 필요한 기능을 요청**하면 됩니다.

✅ **이점**
- 컨트롤러가 서비스 로직에 직접 접근하지 않아 **의존성이 낮아짐**
- 코드가 더 깔끔하고 유지보수하기 쉬워짐
- 서비스 내부 구현을 변경해도 컨트롤러를 수정할 필요 없음

### **빌더 패턴을 적용한 이유**
객체를 생성할 때 필수 값만 설정하고 선택적으로 값을 추가할 수 있도록 **빌더 패턴을 사용**했습니다.
특히 **DTO 변환 과정**에서 빌더 패턴을 활용하면, **명확하고 직관적인 코드**를 작성할 수 있습니다.

✅ **이점**
- **가독성이 좋음** → 필드명을 직접 명시하면서 객체를 생성 가능
- **setter 없이 객체를 불변(Immutable)하게 유지** → 동시성 문제를 줄일 수 있음
- **필수 값과 선택 값을 유연하게 설정 가능**

### **Spring Data Redis + Lettuce를 도입한 이유**
쿠폰 발급과 사용은 **여러 사용자가 동시에 요청하는 환경**에서 실행됩니다.
예를 들어, 특정 이벤트에서 1,000개의 한정 쿠폰을 제공한다고 가정하면, **수천 명의 사용자가 동시에 요청**을 보낼 것입니다.

이때 **동시성 문제**가 발생할 가능성이 높습니다.
- 같은 쿠폰이 여러 번 발급될 수 있음
- 한 사용자가 동일한 쿠폰을 여러 번 사용할 수도 있음

### **이 문제를 해결하기 위해 Redis + Lettuce를 사용했습니다.**
#### 1️⃣ **빠른 데이터 처리**
- Redis는 **인메모리 데이터베이스**이므로 **RDBMS보다 훨씬 빠르게 데이터**를 저장하고 읽어올 수 있습니다.
- 즉, **많은 사용자가 동시에 요청을 보내도 빠르게 응답**할 수 있습니다.

#### 2️⃣ **중복 발급 및 중복 사용 방지**
- Redis의 `SET NX (setIfAbsent)` 기능을 활용하면, **동시에 하나의 요청만 처리되도록 제어**할 수 있습니다.
- 이를 통해 **같은 쿠폰이 여러 번 발급되는 문제를 방지**할 수 있습니다.

#### 3️⃣ **장애 발생 시 빠른 복구 가능**
- Redis는 **고가용성을 지원하는 Sentinel 모드 및 클러스터 모드**를 제공하여 장애 발생 시에도 **빠르게 복구**할 수 있습니다.

#### 4️⃣ **효율적인 리소스 관리**
- 쿠폰 발급 및 사용 기록은 **일정 시간이 지나면 불필요한 데이터가 됩니다.**
- Redis의 **TTL(Time To Live) 기능**을 사용하면, 일정 시간이 지나면 자동으로 데이터가 삭제되므로, **저장 공간을 절약**할 수 있습니다.

### **왜 Spring Data Redis + Lettuce 조합을 선택했을까?**
1. **Spring과의 완벽한 통합** → Spring Boot에서 손쉽게 설정하고 사용할 수 있음
2. **비동기 처리 지원** → Lettuce는 **Netty 기반 논블로킹 I/O**를 제공하여 성능 최적화
3. **높은 안정성과 성능** → Lettuce는 **Sentinel 및 Cluster 모드 지원**을 통해 장애 복구 및 확장성 확보
4. **낮은 네트워크 비용** → 커넥션 풀을 효율적으로 관리하여 Redis 서버와의 불필요한 연결 비용 절감

## 4. 트러블 슈팅
### ❌ **문제 1: User 엔티티와 JPA 관계 오류**
**발생 원인:** `User` 엔티티가 단순한 POJO로 구현되어 있어 **JPA 연관 관계(`@ManyToOne`)** 설정 시 오류 발생

✅ **해결 방법:** `User`를 **JPA 엔티티로 변경**하여 데이터베이스에서 관리되도록 수정

---
### ❌ **문제 2: 쿠폰 중복 발급 문제**
**발생 원인:** 높은 트래픽에서 동일한 쿠폰이 여러 번 발급되는 현상 발생

✅ **해결 방법:** Redis의 `setIfAbsent(NX)`를 활용하여 **분산 락을 적용**하고 중복 요청을 방지

## 5. 추가로 작성할 내용들..
- **테스트 코드 작성 방식**: 동시성 테스트를 어떻게 진행했는지 설명

---

### ✅ **최종 정리**
**쿠폰 매니저 서비스에서는 왜 Redis + Lettuce를 사용했을까?**
- **빠른 데이터 처리**가 필요함
- **동시성 문제 해결**을 위해 `SET NX` 기반 분산 락 적용
- **TTL 기능을 활용한 데이터 자동 삭제**로 불필요한 저장 공간 사용 방지
- **비동기 처리**를 지원하는 Lettuce로 성능 최적화